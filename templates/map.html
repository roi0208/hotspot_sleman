<!DOCTYPE html>
<html>
  <head>
    <title>ONT Command Center - LIFE MEDIA</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <link
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="icon"
      type="image/png"
      href="{{ url_for('static', filename='icons/logo.png') }}"
    />

    <style>
      /* === PALET WARNA KONSISTEN (Diperbarui) === */
      :root {
        --primary-color: #3B82F6; /* Biru seperti dashboard */
        --secondary-color: #1F2937; /* Warna gelap untuk header jika diperlukan */
        --background-color: #F3F4F6;
        --card-bg-color: #FFFFFF;
        --text-dark: #111827;
        --text-light: #6B7280;
        --border-color: #E5E7EB;
        --success-color: #10B981; /* Hijau untuk online */
        --danger-color: #EF4444; /* Merah untuk offline/bahaya */
        --warning-color: #F59E0B;
        --info-color: #3498db; /* Biru terang */
        --shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
      }

      .leaflet-control-custom {
        background-color: var(--card-bg-color);
        padding: 10px;
        border-radius: 8px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
      }
      body {
        font-family: "Poppins", sans-serif; /* Mengubah ke Poppins */
        background: var(--background-color);
        margin: 0;
        color: var(--text-dark);
        overflow: hidden;
      }

      /* PERUBAHAN UTAMA PADA LAYOUT */
      #map {
        height: 100vh;
        width: 100%;
        background-color: var(--background-color);
        padding-left: 350px;
        transition: padding-left 0.35s ease-in-out;
        box-sizing: border-box;
      }
      body.sidebar-collapsed #map {
        padding-left: 0;
      }

      /* Panel Samping - Dibuat agar bisa slide */
      .side-panel {
        position: fixed;
        top: 0;
        left: 0;
        width: 350px;
        height: 100vh;
        background: var(--card-bg-color);
        z-index: 1001;
        box-shadow: 5px 0 15px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        border-right: 1px solid var(--border-color);
        transform: translateX(0);
        transition: transform 0.35s ease-in-out;
      }
      body.sidebar-collapsed .side-panel {
        transform: translateX(-100%);
      }

      /* === PERUBAHAN CSS UNTUK HEADER BARU === */
      .top-header {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1002;
        background: var(--card-bg-color);
        color: var(--text-light);
        padding: 12px 25px;
        border-radius: 50px;
        box-shadow: var(--shadow);
        border: 1px solid var(--border-color);
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .top-header h1 {
        margin: 0;
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--primary-color); /* Diubah ke biru */
      }
      .top-header .header-info {
        display: flex;
        align-items: center;
        gap: 20px;
        margin-left: 15px;
      }
      .top-header .info-item {
        display: flex;
        align-items: center;
        gap: 5px;
      }
      .top-header .info-item i {
        font-size: 1rem;
        color: var(--text-light);
      }
      .top-header .info-item .label {
        font-size: 0.8rem;
        color: var(--text-light);
        font-weight: 400;
        text-transform: uppercase;
      }
      .top-header .info-item .value {
        font-size: 1rem;
        font-weight: 700;
        color: var(--text-dark);
      }
      .top-header .status-indicator {
        width: 10px;
        height: 10px;
        border-radius: 50%;
      }
      .top-header .status-indicator.online {
        background-color: var(--success-color);
      }
      .top-header .status-indicator.offline {
        background-color: var(--danger-color);
      }
      /* Akhir Perubahan CSS Header */

      /* CSS BARU UNTUK TOMBOL BUKA/TUTUP */
      #toggle-sidebar-btn {
        position: fixed;
        top: 50%;
        left: 350px;
        transform: translateY(-50%);
        width: 25px;
        height: 80px;
        background-color: var(--card-bg-color);
        border: 1px solid var(--border-color);
        border-left: none;
        border-radius: 0 10px 10px 0;
        z-index: 1002;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        color: var(--text-dark);
        box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1);
        transition: left 0.35s ease-in-out, background-color 0.2s, color 0.2s;
      }
      #toggle-sidebar-btn:hover {
        background-color: var(--primary-color); /* Diubah ke biru */
        color: white;
        border-color: var(--primary-color);
      }
      body.sidebar-collapsed #toggle-sidebar-btn {
        left: 0;
      }
      #toggle-sidebar-btn .arrow-icon {
        transition: transform 0.35s ease;
      }
      body.sidebar-collapsed #toggle-sidebar-btn .arrow-icon {
        transform: rotate(180deg);
      }

      /* Sisa CSS Anda */
      .panel-header {
        padding: 20px;
        text-align: center;
        border-bottom: 1px solid var(--border-color);
      }
      .panel-header h1 {
        font-size: 1.8rem;
        margin: 0;
        color: var(--primary-color); /* Diubah ke biru */
      }
      .stats-overview {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        padding: 20px;
        border-bottom: 1px solid var(--border-color);
      }
      .stat-box {
        background: var(--background-color);
        border-radius: 8px;
        padding: 15px;
        text-align: center;
      }
      .stat-box .value {
        font-size: 2rem;
        font-weight: 700;
      }
      .stat-box .label {
        font-size: 0.9rem;
        color: var(--text-light);
      }
      #stat-online .value {
        color: var(--success-color);
      }
      #stat-offline .value {
        color: var(--danger-color); /* Konsisten dengan danger-color */
      }
      #stat-total .value {
        color: var(--info-color);
      }
      #stat-users .value {
        color: var(--warning-color);
      }
      .search-filter {
        padding: 20px;
        border-bottom: 1px solid var(--border-color);
      }
      .search-filter input {
        width: 89%;
        background: var(--background-color);
        border: 1px solid var(--border-color);
        border-radius: 5px;
        padding: 10px;
        color: var(--text-dark);
        font-size: 1rem;
      }
      .offline-list-container {
        flex-grow: 1;
        overflow-y: auto;
        padding: 0 20px 20px 20px;
      }
      .offline-list-container h3 {
        margin-top: 20px;
        font-size: 1.2rem;
        color: var(--danger-color); /* Konsisten dengan danger-color */
      }
      .offline-list-item {
        background: rgba(
          239,
          68,
          68,
          0.1
        ); /* Menggunakan alpha dari danger-color */
        border-left: 3px solid var(--danger-color); /* Konsisten dengan danger-color */
        padding: 10px;
        margin-bottom: 8px;
        border-radius: 5px;
        cursor: pointer;
        transition: background 0.2s ease;
      }
      .offline-list-item:hover {
        background: rgba(
          239,
          68,
          68,
          0.2
        ); /* Menggunakan alpha dari danger-color */
      }
      .offline-list-item .name {
        font-weight: 500;
      }
      .offline-list-item .location {
        font-size: 0.85rem;
        color: var(--text-light);
      }
      .top-nav {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1002;
        display: flex;
        gap: 15px;
      }
      .nav-btn {
        background: var(--card-bg-color);
        border: 1px solid var(--border-color);
        color: var(--text-light);
        width: 50px;
        height: 50px;
        border-radius: 50%;
        font-size: 1.2rem;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: var(--shadow);
      }
      .nav-btn:hover {
        background: var(--primary-color); /* Diubah ke biru */
        color: white;
        border-color: var(--primary-color);
      }
      .nav-btn .badge {
        position: absolute;
        top: -5px;
        right: -5px;
        background: var(--danger-color); /* Konsisten dengan danger-color */
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 12px;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      @keyframes sonar-ping {
        0% {
          transform: scale(1);
          opacity: 1;
        }
        80% {
          transform: scale(2.5);
          opacity: 0;
        }
        100% {
          opacity: 0;
        }
      }
      .sonar-ping-emitter {
        position: relative;
      }
      .sonar-ping-emitter::after {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background-color: currentColor;
        transform: translate(-50%, -50%);
        animation: sonar-ping 1.5s ease-out infinite;
      }
    </style>
  <body class="sidebar-collapsed">
    <div class="top-header">
      <h1><i class="fas fa-wifi"></i> Monitoring Sleman</h1>
      <div class="header-info">
        <div class="info-item">
          <i class="fas fa-signal"></i>
          <span class="value" id="header-ont-status">-</span>
          <span class="label">ONT Status</span>
        </div>
        <div class="info-item">
          <i class="fas fa-users"></i>
          <span class="value" id="header-users-count">-</span>
          <span class="label">Users</span>
        </div>
      </div>
    </div>
    <div id="toggle-sidebar-btn" title="Buka/Tutup Panel">
      <i class="fas fa-chevron-left arrow-icon"></i>
    </div>

    <div class="side-panel">
      <div class="panel-header">
        <h1>ONT Command Center</h1>
      </div>
      <div class="stats-overview">
        <div class="stat-box" id="stat-total">
          <div class="value">-</div>
          <div class="label">Total ONT</div>
        </div>
        <div class="stat-box" id="stat-online">
          <div class="value">-</div>
          <div class="label">Online</div>
        </div>
        <div class="stat-box" id="stat-offline">
          <div class="value">-</div>
          <div class="label">Offline</div>
        </div>
        <div class="stat-box" id="stat-users">
          <div class="value">-</div>
          <div class="label">Users Aktif</div>
        </div>
      </div>
      <div class="search-filter">
        <input
          type="text"
          id="searchONT"
          placeholder="Cari nama atau lokasi ONT..."
        />
      </div>
      <div class="offline-list-container">
        <h3><i class="fas fa-triangle-exclamation"></i> Daftar ONT Offline</h3>
        <div id="offline-list">
          <p style="color: #aaa; text-align: center; margin-top: 20px">
            Semua perangkat online.
          </p>
        </div>
      </div>
    </div>

    <div class="top-nav">
      <a href="/dashboard" class="nav-btn" title="Dashboard"
        ><i class="fas fa-tachometer-alt"></i
      ></a>
      <a href="/admin" class="nav-btn" title="Daftar ONT"
        ><i class="fas fa-list"></i
      ></a>
      <a href="/analytics" class="nav-btn" title="Analitik"
        ><i class="fas fa-chart-pie"></i
      ></a>
      <a
        href="/notifications"
        class="nav-btn"
        title="Notifikasi"
        style="position: relative"
      >
        <i class="fas fa-bell"></i>
        <span class="badge" id="notificationBadge" style="display: none"
          >0</span
        >
      </a>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

    <script>
      // SCRIPT BAWAAN ANDA DIMULAI DI SINI
      const map = L.map("map").setView([-7.797068, 110.370529], 9);
      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution:
          '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        maxZoom: 20,
      }).addTo(map);

      let allOntData = [];
      let markers = L.layerGroup();
      let lastStatus = {};
      let isFirstLoad = true;

      // --- NEW: kontrol auto-fit untuk mencegah override setelah user interaksi ---
      let autoFitEnabled = true;
      const AUTO_FIT_DISABLE_MS = 60000; // nonaktifkan auto-fit sementara 60 detik setelah interaksi
      let autoFitTimer = null;

      function disableAutoFitTemporarily(ms = AUTO_FIT_DISABLE_MS) {
        autoFitEnabled = false;
        if (autoFitTimer) clearTimeout(autoFitTimer);
        autoFitTimer = setTimeout(() => {
          autoFitEnabled = true;
          autoFitTimer = null;
        }, ms);
      }

      // jika user mulai melakukan interaksi dengan peta, suppress auto-fit sementara
      map.on("movestart zoomstart dragstart", function () {
        disableAutoFitTemporarily();
      });

      // Fungsi untuk mengupdate info status di header
      function updateHeaderInfo(onts) {
        const totalOnline = onts.filter((ont) => ont.status.startsWith("ON")).length;
        const totalOnts = onts.length;
        const onlinePercentage = totalOnts > 0 ? ((totalOnline / totalOnts) * 100).toFixed(0) : 0;

        const ontStatusElement = document.getElementById("header-ont-status");
        ontStatusElement.innerHTML = `${onlinePercentage}%`;
        ontStatusElement.style.color = totalOnline === totalOnts ? 'var(--success-color)' : 'var(--danger-color)'; /* Diubah ke variabel CSS */
      }

      function updateStats(onts) {
        const total = onts.length;
        const online = onts.filter((ont) => ont.status.startsWith("ON")).length;
        const offline = total - online;

        document.getElementById("stat-total").querySelector(".value").textContent = total;
        document.getElementById("stat-online").querySelector(".value").textContent = online;
        document.getElementById("stat-offline").querySelector(".value").textContent = offline;

        updateHeaderInfo(onts); // Panggil fungsi baru

        const offlineList = document.getElementById("offline-list");
        const offlineOnts = onts.filter((ont) => !ont.status.startsWith("ON"));
        offlineList.innerHTML = "";
        if (offlineOnts.length > 0) {
          offlineOnts.forEach((ont) => {
            const item = document.createElement("div");
            item.className = "offline-list-item";
            item.innerHTML = `<div class="name">${ont.name}</div><div class="location">${ont.lokasi || ""}</div>`;
            item.onclick = () => {
              map.setView([ont.latitude, ont.longitude], 18);
              // treat as user interaction (suppress auto-fit temporarily)
              disableAutoFitTemporarily();
            };
            offlineList.appendChild(item);
          });
        } else {
          offlineList.innerHTML = '<p style="color: #aaa; text-align: center; margin-top: 20px;">Semua perangkat online.</p>';
        }
      }

      function getMikrotikUserCount() {
        fetch("/api/history")
          .then((res) => res.json())
          .then((data) => {
            if (data.length > 0) {
              const userCount = data[data.length - 1].users;
              document.getElementById("stat-users").querySelector(".value").textContent = userCount;
              document.getElementById("header-users-count").textContent = userCount;
            } else {
              document.getElementById("stat-users").querySelector(".value").textContent = "0";
              document.getElementById("header-users-count").textContent = "0";
            }
          })
          .catch((err) => {
            console.error('Error fetching history:', err);
          });
      }

      function applySonarEffect(marker, color) {
        const iconDiv = marker._icon;
        if (iconDiv) {
          iconDiv.style.color = color;
          iconDiv.classList.add("sonar-ping-emitter");
          setTimeout(() => {
            if (iconDiv) iconDiv.classList.remove("sonar-ping-emitter");
          }, 3000);
        }
      }

      function renderMarkers(onts) {
        markers.clearLayers();
        let skipped = 0;
        onts.forEach((ont) => {
          if (typeof ont.latitude !== 'number' || typeof ont.longitude !== 'number' || isNaN(ont.latitude) || isNaN(ont.longitude)) {
            skipped++;
            return;
          }
          let onColor, offColor;
          // Menggunakan variabel CSS untuk konsistensi
          onColor = 'var(--success-color)'; 
          offColor = 'var(--danger-color)';

          const isOnline = ont.status.startsWith("ON");
          const color = isOnline ? onColor : offColor;
          const iconHtml = `<div style="background-color:${color};width:29px;height:29px;border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 2px 5px rgba(0,0,0,0.2);color:#ffffff;font-size:1rem;"><i class="fas fa-wifi"></i></div>`;
          const icon = L.divIcon({
            html: iconHtml,
            iconSize: [24, 24],
            className: "",
            iconAnchor: [12, 12] /* Sesuaikan anchor agar center */
          });
          const marker = L.marker([ont.latitude, ont.longitude], { icon });

          let popupContent = `<b>${ont.name}</b>`;
          if (ont.lokasi)
            popupContent += `<br><span style='font-size: 0.9em; color: var(--text-light);'>${ont.lokasi}</span>`; /* Menggunakan variabel CSS */
          popupContent += `<br>IP: <a href='http://${ont.ip}' target='_blank' style='color:var(--primary-color);'>${ont.ip}</a>`; /* Menggunakan variabel CSS */
          popupContent += `<br>Status: <span style='color:${color};'>${ont.status}</span>`;
          marker.bindPopup(popupContent);

          marker.on("mouseover", function (e) {
            this.openPopup();
          });
          marker.on("mouseout", function (e) {
            this.closePopup();
          });
          marker.addTo(markers);

          if (
            lastStatus[ont.id] !== undefined &&
            lastStatus[ont.id] !== isOnline
          ) {
            applySonarEffect(marker, color);
          }
          lastStatus[ont.id] = isOnline;
        });
        map.addLayer(markers);
        if (skipped > 0) console.warn(`Skipped ${skipped} ONT(s) without valid coordinates`);
      }

      function loadAllData() {
        fetch("/api/onts")
          .then((res) => res.json())
          .then((data) => {
            allOntData = data;
            updateStats(data);
            renderMarkers(data.filter(ont => typeof ont.latitude === 'number' && typeof ont.longitude === 'number'));

            const coordinates = data.map((ont) => [ont.latitude, ont.longitude]).filter(coord => !isNaN(coord[0]) && !isNaN(coord[1]));
            if (coordinates.length > 0) {
              const bounds = L.latLngBounds(coordinates);
              // Hanya auto-fit saat first load atau bila autoFitEnabled = true
              if (isFirstLoad || autoFitEnabled) {
                map.fitBounds(bounds, { padding: [50, 50] });
                isFirstLoad = false;
              } else {
                // tidak melakukan fitBounds agar tidak override view user
                // (kemungkinan kita bisa debug/log di sini jika perlu)
              }
            }
          })
          .catch((err) => {
            console.error('Error loading ONTs:', err);
          });
        getMikrotikUserCount();
      }

      document.getElementById("searchONT").addEventListener("input", function (e) {
        const searchTerm = e.target.value.toLowerCase();
        const filteredOnts = allOntData.filter(
          (ont) =>
            (ont.name && ont.name.toLowerCase().includes(searchTerm)) ||
            (ont.lokasi && ont.lokasi.toLowerCase().includes(searchTerm))
        );
        renderMarkers(filteredOnts);
      });

      loadAllData();
      setInterval(loadAllData, 5000);

      // --- SCRIPT BARU UNTUK FUNGSI BUKA-TUTUP DENGAN LOCALSTORAGE ---
      document.addEventListener("DOMContentLoaded", function () {
        const toggleButton = document.getElementById("toggle-sidebar-btn");

        if (localStorage.getItem("sidebar") === "expanded") {
          document.body.classList.remove("sidebar-collapsed");
        }

        toggleButton.addEventListener("click", function () {
          document.body.classList.toggle("sidebar-collapsed");

          if (document.body.classList.contains("sidebar-collapsed")) {
            localStorage.setItem("sidebar", "collapsed");
          } else {
            localStorage.setItem("sidebar", "expanded");
          }

          setTimeout(function () {
            map.invalidateSize();
          }, 350);
        });
      });

      // === Custom Control Legenda di Peta ===
      L.Control.LegendCustom = L.Control.extend({
        onAdd: function (map) {
          let div = L.DomUtil.create("div", "leaflet-control-custom");
          div.innerHTML = `
            <div style="font-size:12px; line-height:1.4; font-family: 'Poppins', sans-serif;">
              <b>Legenda</b><br>
              <span style="color:var(--success-color);">●</span> ONT Online<br>
              <span style="color:var(--danger-color);">●</span> ONT Offline<br>
            </div>
          `;
          return div;
        },
        onRemove: function (map) {},
      });

      // === Custom Control: Fit Area ===
      L.Control.FitArea = L.Control.extend({
        onAdd: function (map) {
          let container = L.DomUtil.create("div", "leaflet-bar leaflet-control");
          let button = L.DomUtil.create("a", "", container);
          button.innerHTML = '<i class="fas fa-expand-arrows-alt"></i>';
          button.href = "#";
          button.title = "Pusatkan Peta ke Semua Marker";

          L.DomEvent.on(button, "click", function (e) {
            L.DomEvent.stopPropagation(e);
            L.DomEvent.preventDefault(e);

            if (typeof markers !== "undefined" && markers.getLayers().length > 0) {
              let group = L.featureGroup(markers.getLayers());
              map.fitBounds(group.getBounds().pad(0));
              // Setelah user klik Fit Area, kita nonaktifkan auto-fit sementara agar view tidak di-override
              disableAutoFitTemporarily();
            } else {
              alert("Tidak ada marker untuk difit.");
            }
          });

          return container;
        },
        onRemove: function (map) {},
      });

      // === Tambahkan Legenda & Fit Area ke Peta ===
      document.addEventListener("DOMContentLoaded", function () {
        if (typeof map !== "undefined") {
          new L.Control.FitArea({ position: "topleft" }).addTo(map);
          new L.Control.LegendCustom({ position: "bottomleft" }).addTo(map);
        }
      });
    </script>
  </body>
</html>